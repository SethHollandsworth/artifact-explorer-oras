<!DOCTYPE html>
<html lang="en">
  {{ template "artifactHeader" }}
  <body>
    {{ template "navbar" }}

    <!-- hero form -->
    <div class="hero">
      <div class="hero_about"></div>
      <div class="form">
        <h1>Enter artifact details</h1>
        <div class="ui fluid selection dropdown">
          <input type="hidden" name="registry" />
          <i class="dropdown icon"></i>
          <div class="default text">Select registry</div>
          <div class="menu">
            <div class="item" data-value="docker.io/">
              <img
                class="ui mini avatar image"
                src="./static/images/registryImages/image1.svg"
              />
              docker.io/
            </div>
            <div class="item" data-value="gcr.io/">
              <img
                class="ui mini avatar image"
                src="./static/images/registryImages/image2.svg"
              />
              gcr.io/
            </div>
          </div>
        </div>

        <div class="form-floating mb-3">
          <input
            type="text"
            class="form-control"
            id="floatingInput"
            placeholder="library/nginx"
          />
          <label for="floatingInput">Repository name</label>
        </div>

        <div class="ui right labeled input">
          <input type="text" placeholder="Enter tag or digest" name="tag" />
          <div class="ui dropdown label">
            <div class="text" id="digestortag">Tag</div>
            <i class="dropdown icon"></i>
            <div class="menu">
              <div class="item">Tag</div>
              <div class="item">Digest</div>
            </div>
          </div>
        </div>
        <a href="#content_area">
          <button onclick="onSubmit()">
            <div class="icon">
              <img src="./static/images/downArrow.svg" alt="" />
            </div>
            Explore contents
          </button>
        </a>
      </div>
    </div>

    <!-- artifact content section -->
    <div id="content_area">
      <h1>Artifact</h1>
      <div class="ui labeled input">
        <div class="ui label">Content-Digest:</div>
        <input type="text" placeholder="not available" disabled />
      </div>
      <div class="ui labeled input">
        <div class="ui label">Content-Length:</div>
        <input type="text" placeholder="not available" disabled />
      </div>
      <div class="ui labeled input">
        <div class="ui label">MediaType:</div>
        <input type="text" placeholder="not available" disabled />
      </div>
    </div>

    {{ template "footer" }}
    <script>
      $(".ui.dropdown").dropdown();
      const reg = document.querySelector(
        'input[type="hidden"][name="registry"]'
      );
      const repo = document.querySelector("#floatingInput");
      const tagValue = document.querySelector('input[name="tag"]');
      const tag = document.querySelector("#digestortag");

      const artifact = document.querySelector("#content_area");
      const rows = document.querySelectorAll("#table_digest");

      function onSubmit() {
        const URL =
          tag.innerHTML === "Tag"
            ? `/api/artifact?registry=${reg.value}&name=${repo.value}&tag=${tagValue.value}`
            : `/api/artifact?registry=${reg.value}&name=${repo.value}&digest=${tagValue.value}`;
        getArtifactContents(URL);
      }

      function getContentsByDigest(item) {
        const URL = `/api/artifact?registry=${reg.value}&name=${repo.value}&digest=${item.Digest}`;
        console.log(URL);
        getArtifactContents(URL);
      }

      function getManifestTable(manifests) {
        let records = "";
        manifests.forEach((item, ind) => {
          records += `
          <tr>
        <td>${item.mediaType}</td>
        <td>${item.size}</td>
        <td id="table_digest" onclick="getContentsByDigest(${JSON.stringify({
          Digest: item.digest,
        })})">${item.digest}</td>
      </tr>
              `;
        });
        const table = `
        <table class="ui fixed single line celled table">
        <thead>
        <tr>
          <th scope="col">Mediatype</th>
          <th scope="col">Size</th>
          <th scope="col">Digest</th>
          <th scope="col">Platform</th>
        </tr>
        </thead>
        ${records}
        </table>`;

        return table;
      }

      function getArtifactContents(URL) {
        artifact.innerHTML = `
        <div class="spinner-border text-info" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        `;

        fetch(URL)
          .then((res) => res.json())
          .then((data) => {
            // console.log(data);
            const manifests = data.Manifests;

            artifact.innerHTML = `
          <h1>Artifact</h1>
          <div class="ui labeled input">
            <div class="ui label">Content-Digest:</div>
            <input type="text" placeholder="not available" value=${
              data.Artifact
            } disabled />
          </div>
          <div class="ui labeled input">
            <div class="ui label">Content-Length:</div>
            <input type="text" placeholder="not available" value=${
              data.ContentLength
            } disabled />
          </div>
          <div class="ui labeled input">
            <div class="ui label">MediaType:</div>
            <input type="text" placeholder="not available" value=${
              data.MediaType
            } disabled />
          </div>
          ${manifests ? getManifestTable(manifests) : ""}
          `;
          })
          .catch((err) => console.log(err));
      }
    </script>
  </body>
</html>
